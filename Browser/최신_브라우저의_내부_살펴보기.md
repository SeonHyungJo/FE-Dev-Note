# 최신 브라우저의 내부 살펴보기

어느 제품을 개발하고 운영하다 보면 성능(performance)를 올려야 하는 일은 생긴다. 모든 이유는 사용자의 입장에서 사용성이 좋아지기 위해서 이다.

성능을 높이는 방법 중 하나인 GPU를 사용하는 방법이 있다. 이를 흔히 **하드웨어 가속화**라고 부른다. 

> 참고 : 특정 작업을 CPU가 아닌 다른 특별한 장치를 통해 수행 속도를 높이는 것을 '**하드웨어 가속(hardware accelerated)**'라 한다. 
> 
> 브라우저에서의 하드웨어 가속이란 GPU를 사용하여 그래픽 작업을 가속하는 것을 의미한다. **간단한 작업을 동시에 수많은 코어가 수행하는 GPU의 특성**을 기반으로 그래픽 작업이 훨씬 빠르게 처리될 수 있다.
> 
> 영상으로 CPU와 GPU의 차이를 보면 한 번에 이해가 될 것이다.[CPU vs GPU(YouTube)](https://www.youtube.com/watch?v=-P28LKWTzrI)


브라우저에 대해 알아보기 전 기본적인 내용을 학습해보자.

## CPU(중앙처리장치)

컴퓨터 가장 중요한 부품인 **중앙처리장치**이다. 흔히 연산을 담당하는 곳으로 사람으로 따지면 뇌라고 한다. 예전 CPU는 단일로 구성되어 있었지만, 요즘은 CPU 하나 안에 코어가 여러 개를 넣으면서 성능을 높이고 있다. 

## GPU(그래픽처리장치)

GPU는 **그래픽처리장치**로 CPU와 다르게 GPU는 간단한 작업에만 특화가 되었는데 여러 GPU 코어를 동시에 사용하여 작업할 수 있다.

이름에서 알 수 있듯이 GPU는 **그래픽 작업을 처리하기 위해 만들어졌다.**  빠른 렌더링과 매끄러운 표현을 하는데 특화되어 있다. 최근 GPU 가속을 통해 GPU가 단독으로 처리할 수 있는 계산이 점점 더 많아졌다.

## 프로세스와 스레드(Process and Thread)

<p align='center'>
  <img src='https://user-images.githubusercontent.com/24274424/58023551-01888a80-7b4b-11e9-91a9-2ef7f8323ac8.png' alt='위키_스레드 (컴퓨팅)'>
</p>

브라우저 아키텍처를 살펴보기 전에 파악해야 할 개념은 프로세스와 스레드이다. 

프로세스는 애플리케이션이 실행하는 프로그램이라고 하며, 스레드는 프로세스 내부에 있으며 프로세스로 실행되는 프로그램의 일부를 실행한다.

애플리케이션을 시작하면 프로세스가 하나가 만들어진다. 프로세스가 작업하기 위해 스레드를 생성할 수도 있지만 선택 사항이며, 애플리케이션을 닫으면 프로세스가 사라지고 운영체제가 메모리를 비운다.

프로세스는 여러 작업을 수행하기 위해 운영체제에 다른 프로세스를 실행하라고 요청할 수 있다. 그러면 메모리의 다른 부분이 새 프로세스에 할당된다. 두 개 이상의 프로세스가 서로 정보를 공유해야 할 때는 **IPC(inter process communication, 프로세스 간 통신)** 를 사용한다. 대부분의 애플리케이션이 이 방식으로 설계되어 있다. 작업 프로세스가 응답하지 않을 때 애플리케이션의 다른 부분을 실행하는 프로세스를 중지하지 않고 응답하지 않는 프로세스만 다시 시작할 수 있다.

## 브라우저 아키텍처

브라우저는 프로세스와 스레드를 어떻게 사용할까? 스레드를 사용하는 방법은 크게 방법은 2가지가 있다.

1. 스레드를 많이 사용하는 프로세스 하나만 사용하는 방법
2. 스레드를 조금만 사용하는 프로세스를 여러 개 만들어 IPC로 통신하는 방법

### **Chrome의 아키텍처**

기본적으로 크롬은 **다중 프로세스 아키텍처(멀티프로세스 싱글 스레드)**이다. 말에서 알 수 있듯이 여러 개의 프로세스로 작업이 이루어지며 각각의 프로세스는 1개의 스레드를 가진다.

크롬에서 상위의 브라우저 프로세스는 애플리케이션의 **각 부분을 맡는 다른 프로세스**를 조정한다. 렌더러 프로세스는 여러 개가 만들어져 탭마다 할당이 된다. 

Chrome은 **탭마다 프로세스를 할당**했다. 다른 옵션으로는 사이트(iframe에 있는 사이트 포함)마다 프로세스를 할당할 수 있는 방법이 있다.

### 어떤 프로세스가 무엇을 담당하나

- **브라우저 프로세스**	 : 주소 표시줄, 북마크 막대, 뒤로 가기 버튼, 앞으로 가기 버튼 등 애플리케이션의 *Chrome* 부분을 제어한다. 네트워크 요청이나 파일 접근과 같이 눈에 보이지 않지만, 권한이 필요한 부분도 처리한다.
- **렌더러 프로세스**	: 탭 안에서 웹 사이트가 표시되는 부분의 모든 것을 제어한다.
- **플러그인 프로세스**	: 웹 사이트에서 사용하는 플러그인(예: Flash)을 제어한다.
- **GPU 프로세스** : GPU 작업을 다른 프로세스와 격리돼서 처리한다. GPU는 여러 애플리케이션의 요청을 처리하고 같은 화면에 요청받은 내용을 그리기 때문에 GPU 프로세스는 별도 프로세스로 분리되어 있다.

이 외에도 확장 프로그램(Extension) 프로세스, 유틸리티 프로세스 등 더 많은 프로세스가 있다.

> Chrome에서 실행 중인 프로세스를 확인이 가능하다.(도구 더보기 > 작업 관리자) 

### **다중 프로세스 아키텍처가 Chrome에 주는 이점**

Chrome은 여러 개의 렌더러 프로세스를 사용한다. 예로 탭마다 렌더러 프로세스를 하나씩 사용하는 경우를 생각해보자. 3개의 탭이 열려 있고 각 탭은 독립적인 렌더러 프로세스에 의해 실행된다면, 한 탭이 응답하지 않으면 그 탭만 닫고 실행 중인 다른 탭으로 이동할 수 있다. 모든 탭이 하나의 프로세스에서 실행 중이었다면 탭이 하나만 응답하지 않아도 모든 탭이 죽는 일이 벌어졌을 것이다(ex. IE).

브라우저의 작업을 여러 프로세스에 나눠서 처리하는 방법의 또 다른 장점은 **보안과 격리**이다. 운영체제를 통해 프로세스의 권한을 제한할 수 있어 브라우저는 특정 프로세스가 특정 기능을 사용할 수 없게 제한할 수 있다. 

예를 들어 Chrome은 렌더러 프로세스처럼 사용자 입력을 처리하는 프로세스가 임의의 파일에 접근하지 못하게 제한하는 것이다.

프로세스는 전용 메모리 공간을 사용하기 때문에 공통부분(ex. Chrome의 JavaScript Engine == V8)을 복사해서 가지고 있는 경우가 많다. 동일한 프로세스의 스레드가 메모리를 공유할 수 있는데 반해 서로 다른 프로세스는 메모리를 공유할 수 없어 메모리 사용량이 더 많아진다. Chrome은 메모리를 절약하기 위해서 실행할 수 있는 프로세스의 개수를 제한한다. 정확한 한도는 기기의 메모리 용량과 CPU 성능에 따라 다르지만, 프로세스의 개수가 한도에 다다르면 동일한 사이트를 열고 있는 여러 탭을 하나의 프로세스에서 처리한다.

### 더 많은 메모리 절약 - Chrome의 서비스화

Chrome은 브라우저의 각 부분을 서비스로 실행해 여러 프로세스로 쉽게 분할하거나 하나의 프로세스로 통합할 수 있도록 아키텍처를 변경하고 있다.

성능이 좋은 하드웨어에서 Chrome이 실행 중일 때에는 각 서비스를 여러 프로세스로 분할해 안정성을 높이고, 리소스가 제한적인 장치에서 실행 중일 때에는 서비스를 하나의 프로세스에서 실행해서 메모리 사용량을 줄이는 것이 기본 아이디어이다. 메모리 절약을 위해 프로세스를 합치는 이런 방식은 `Android`와 같은 플랫폼에서는 이전부터 사용되고 있었다.

### 프레임별로 실행되는 렌더러 프로세스 - 사이트 격리

`iframe`는 사이트를 별도의 렌더러 프로세스에서 실행하는 것이다. 탭마다 렌더러 프로세스를 할당하는 모델에서는 `iframe`의 사이트가 같은 렌더러 프로세스에서 작동하기 때문에 서로 다른 사이트 간에 메모리가 공유될 수 있다는 문제가 있어 지속적으로 논의가 있었다. 

a.com 사이트의 웹 페이지와 b.com 사이트의 웹 페이지를 동일한 렌더러 프로세스에서 실행하는 것이 문제가 없어 보일 수 있다. 하지만 **동일 출처 정책(same origin policy)** 은 웹 보안 모델의 핵심이다. 한 사이트는 동의 없이 다른 사이트의 데이터에 접근할 수 없어야 한다. 

이 정책을 우회하는 것이 바로 보안 공격의 주요 목표이다. 프로세스를 격리하는 것이 사이트를 격리하는 가장 효과적인 방법이다. **Meltdown과 Spectre 사태**로 여러 프로세스를 사용해 사이트를 격리해야 한다는 것이 더욱 분명해졌다. Chrome 67부터 데스크톱에서 사이트 격리를 기본으로 사용하도록 설정하면서 탭에서 `iframe` 의 사이트에 별도의 렌더러 프로세스가 적용된다.

사이트 격리를 위해 여러 해에 걸친 노력이 있었다. 사이트 격리는 다른 렌더러 프로세스를 할당하는 것만큼 간단하지 않다. `iframe` 이 서로 통신하는 방식을 근본적으로 바꿔야 하기 때문이다. 다른 프로세스에서 실행되는 `iframe` 이 있는 웹 페이지에서 개발자 도구를 자연스럽게 사용하게 하려면 눈에 보이지 않은 많은 작업이 뒤에서 이루어져야 한다. 또 단순히 `Ctrl + F` 키를 눌러 페이지에서 단어를 찾으려고 해도 서로 다른 렌더러 프로세스를 오가며 찾아야 한다.

---

#### Reference

- [최신 브라우저의 내부 살펴보기 1 - CPU, GPU, 메모리 그리고 다중 프로세스 아키텍처](https://d2.naver.com/helloworld/2922312)
- [인텔 사태, CPU 보안 이슈 정리, 멜트다운(Meltdown)](https://fillin.tistory.com/259)